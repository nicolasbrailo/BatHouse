# Install instructions

This readme has been tested in a RaspberryPi 3, but it should be applicable to any Linux-y system.

Besides hardware, running dumbhouse requires:

1. An mqtt broker
2. zigbee2mqtt
3. A bunch of pipenv dependencies

* Important *
Give your devices friendly names in zigbee2mqtt - otherwise dumbhouse will display them by their ID.

## Mqtt server
1. Mosquitto is easiest:
$ sudo apt-get install mosquitto


## Zigbee2mqtt
### Install zigbee2mqtt / https://www.zigbee2mqtt.io/
Note: instructions here not quite the same as https://www.zigbee2mqtt.io/getting_started/running_zigbee2mqtt.html

$ sudo git clone https://github.com/Koenkk/zigbee2mqtt.git
$ npm install
$ npm start

### Configure zigbee2mqtt

1. zigbee2mqtt keeps device info in zigbee2mqtt/data/database.db. Backup the db file and move it around if you change zigbee2mqtt's directory.
2. Give it a test run, try out (and pair) all devices. Then edit configuration.yaml - give friendly names to all discovered devices.
3. Link zigbee2mqtt.service to /etc/systemd/system/zigbee2mqtt.service to make it a system service.
4. Usueful control commands:

 # Show status
 sudo systemctl enable zigbee2mqtt.service
 # Enable service
 systemctl status zigbee2mqtt.service
 # Start zigbee2mqtt
 $ sudo systemctl start zigbee2mqtt
 # Stopping zigbee2mqtt
 sudo systemctl stop zigbee2mqtt
 # View the log of zigbee2mqtt
 sudo journalctl -u zigbee2mqtt.service -f

### Zigbee stick crashes?
* Too many concurrent messages received by the usb stick might make it crash: https://github.com/Koenkk/zigbee2mqtt/issues/1181
	* try increasing this lib/util/zigbeeQueue.js to e.g. const delay = 500; or maxSimultaneouslyRunning = 2;
		This should reduce the traffic to the CC2531. 
	* Add to mosquitto.conf "max_inflight_messages 5" to reduce the number of concurrent messages
	* Use qos=1 when publishing messages and subscribing to topics in Mosquitto

More troubleshooting
* https://github.com/Koenkk/zigbee2mqtt/issues/156 


## Run dumbhouse

## Config
Edit config.json.example with right config

## Install service:
$ cd /etc/systemd/system && sudo ln -s /home/pi/dumbhouse/dumbhouse.service 
$ sudo systemctl enable dumbhouse

## Start and stop:
$ sudo systemctl start dumbhouse
$ sudo systemctl stop dumbhouse

## Status:
$ systemctl status dumbhouse
$ sudo journalctl -u dumbhouse -f


