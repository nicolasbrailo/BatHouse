<!DOCTYPE html>
<html>
<head>
    <link rel="icon" href="favicon.ico" type="image/x-icon"/>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon"/>
    <title>BatHome</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

    <!-- https://getbootstrap.com/docs/3.4/customize/ -->
    <link rel="stylesheet" href="/ZMF/webapp/css/bootstrap.min.css">
    <link rel="stylesheet" href="/ZMF/webapp/css/bootstrap-theme.min.css">
    
    <!-- Handlebars -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.1.1/handlebars.min.js"></script>

    <!-- Dygraph -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.js"></script>
    <script src="http://dygraphs.com/extras/smooth-plotter.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.css" />
</head>
<body>
<div class="container-fluid">
    <h2>CO2/Temp</h2>
    <div id="co2_temp" style="width: 100%"></div>

    <h2>Rain forecast</h2>
    <div id="rain_forecast" style="width: 100%"></div>

    <h2>Temperature forecast, hourly</h2>
    <div id="temp_forecast" style="width: 100%"></div>

    <script type="text/javascript">
      // http://dygraphs.com/options.html

      new Dygraph(
        document.getElementById("co2_temp"),
        "co2_history.csv?random=" + new Date().getTime(),
        {
            labels: [ 'Date', 'Temperature', 'CO2'],
            ylabel: 'CO2 PPM',
            y2label: 'Temperature (C)',
            series: {
                'Temperature': {'axis': 'y2'/*, 'plotter': smoothPlotter*/},
                'CO2': {'axis': 'y', 'plotter': smoothPlotter}
            },
            axes: {
              y2: {
                  // valueRange: [0, 35],
              },
              x: {
                  valueFormatter: function(d) {
                      return new Date(d*1000);
                  },
                  axisLabelFormatter: function(d, gran, opts) {
                      var t = new Date(d*1000);
                      return t.getHours() + ":" + t.getMinutes() + " " + t.getDay() + "/" + t.getMonth();
                  }
              }
            },
            highlightCircleSize: 2,
            strokeWidth: 1,
            highlightSeriesOpts: {
              strokeWidth: 3,
              strokeBorderWidth: 1,
              highlightCircleSize: 5
            }
        }
      );

      $.ajax({
          url: "https://cdn-secure.buienalarm.nl/api/3.4/forecast.php?lat=52.37064&lon=4.94223&region=nl&unit=mm/u",
          cache: false,
          type: 'get',
          dataType: 'json',
          success: function(forecast) {
              var csv = "Date,Rain(mm/h)\n";
              var t = forecast.start;
              for (var rain of forecast.precip) {
                  csv += t + "," + rain + "\n";
                  t += forecast.delta;
              }

              new Dygraph(
                  document.getElementById("rain_forecast"),
                  csv,
                  {
                      series: {
                          'Rain(mm/h)': {'plotter': smoothPlotter}
                      },
                      axes: {
                          y: {valueRange: [0, 5],},
                          x: {
                              valueFormatter: function(d) { return new Date(d*1000); },
                              axisLabelFormatter: function(d, gran, opts) {
                                  var t = new Date(d*1000);
                                  return t.getHours() + ":" + t.getMinutes();
                              }
                          }
                      },
                      underlayCallback: function(ctx, area, graph) {
                          function horizontalLine(y_val, color) {
                              var xl = graph.toDomCoords(0,y_val);
                              ctx.strokeStyle= color;
                              ctx.beginPath();
                              ctx.moveTo(xl[0],xl[1]);
                              ctx.lineTo(9e22,xl[1]);
                              ctx.closePath();
                              ctx.stroke();      
                          }

                          horizontalLine(0.25, 'green');
                          horizontalLine(1, 'yellow');
                          horizontalLine(2.5, 'red');
                      }
                  }
              );
          }
      });

      $.ajax({
          url: "https://api.meteoplaza.com/v2/meteo/completelocation/5237.494?lang=en",
          cache: false,
          type: 'get',
          dataType: 'json',
          success: function(forecast) {
              var csv = "";
              for(var h of forecast.Hourly.slice(0, 72)) {
                  csv += h.ValidDt + "," + h.TTTT + "\n";
              }

              new Dygraph(
                  document.getElementById("temp_forecast"),
                  csv,
                  {
                      fillGraph: true,
                      labels: [ 'Date', 'Temp (C)'],
                  }
              );
          },
      });
    </script>
</div>
</body>
</html>

